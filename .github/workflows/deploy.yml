name: Manual Deploy

on:
  workflow_dispatch:
    inputs:
      ref:
        description: "Git ref to deploy (branch, tag, or SHA)"
        required: true
        default: "main"
        type: string
      environment:
        description: "GitHub Environment gate"
        required: true
        default: "production"
        type: choice
        options:
          - production
      restart_only:
        description: "Restart service only (skip build + release upload)"
        required: true
        default: false
        type: boolean
      run_live_check:
        description: "Run `edgelord check live` before restart"
        required: true
        default: true
        type: boolean

permissions:
  contents: read

concurrency:
  group: manual-deploy-${{ inputs.environment }}
  cancel-in-progress: false

env:
  CARGO_TERM_COLOR: always

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    steps:
      - name: Checkout selected ref
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}

      - name: Resolve release SHA
        id: release
        run: echo "sha=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"

      - name: Install Rust toolchain
        if: ${{ !inputs.restart_only }}
        uses: dtolnay/rust-toolchain@stable

      - name: Build release binary
        if: ${{ !inputs.restart_only }}
        run: cargo build --release

      - name: Run tests (release profile)
        if: ${{ !inputs.restart_only }}
        run: cargo test --release

      - name: Configure SSH
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_SSH_PORT: ${{ secrets.DEPLOY_SSH_PORT }}
          DEPLOY_SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
          DEPLOY_KNOWN_HOSTS: ${{ secrets.DEPLOY_KNOWN_HOSTS }}
        run: |
          set -euo pipefail
          test -n "$DEPLOY_HOST"
          test -n "$DEPLOY_SSH_PORT"
          test -n "$DEPLOY_SSH_KEY"
          test -n "$DEPLOY_KNOWN_HOSTS"

          mkdir -p ~/.ssh
          printf '%s\n' "$DEPLOY_SSH_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          printf '%s\n' "$DEPLOY_KNOWN_HOSTS" > ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      - name: Upload release binary
        if: ${{ !inputs.restart_only }}
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_SSH_PORT: ${{ secrets.DEPLOY_SSH_PORT }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          RELEASE_SHA: ${{ steps.release.outputs.sha }}
        run: |
          set -euo pipefail
          test -n "$DEPLOY_USER"
          scp \
            -i ~/.ssh/id_ed25519 \
            -P "$DEPLOY_SSH_PORT" \
            target/release/edgelord \
            "$DEPLOY_USER@$DEPLOY_HOST:/tmp/edgelord-$RELEASE_SHA"

      - name: Deploy and restart
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_SSH_PORT: ${{ secrets.DEPLOY_SSH_PORT }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
          RELEASE_SHA: ${{ steps.release.outputs.sha }}
          RESTART_ONLY: ${{ inputs.restart_only }}
          RUN_LIVE_CHECK: ${{ inputs.run_live_check }}
        run: |
          set -euo pipefail
          test -n "$DEPLOY_USER"
          test -n "$DEPLOY_PATH"

          ssh \
            -i ~/.ssh/id_ed25519 \
            -p "$DEPLOY_SSH_PORT" \
            "$DEPLOY_USER@$DEPLOY_HOST" \
            "DEPLOY_PATH='$DEPLOY_PATH' DEPLOY_USER='$DEPLOY_USER' RELEASE_SHA='$RELEASE_SHA' RESTART_ONLY='$RESTART_ONLY' RUN_LIVE_CHECK='$RUN_LIVE_CHECK' BINARY_STAGING='/tmp/edgelord-$RELEASE_SHA' bash -s" <<'REMOTE'
            set -euo pipefail

            CONFIG_PATH="$DEPLOY_PATH/config/config.toml"
            CURRENT_LINK="$DEPLOY_PATH/current"
            RELEASE_DIR="$DEPLOY_PATH/releases/$RELEASE_SHA"
            PREV_TARGET="$(readlink -f "$CURRENT_LINK" || true)"

            rollback() {
              echo "Deployment failed; attempting rollback"
              if [[ -n "${PREV_TARGET:-}" && -d "$PREV_TARGET" ]]; then
                ln -sfn "$PREV_TARGET" "$CURRENT_LINK"
                if [[ -x "$CURRENT_LINK/edgelord" ]]; then
                  sudo "$CURRENT_LINK/edgelord" service install --config "$CONFIG_PATH" --user "$DEPLOY_USER" --working-dir "$DEPLOY_PATH" || true
                fi
                sudo systemctl restart edgelord || true
                sudo systemctl is-active edgelord || true
              fi
            }

            trap rollback ERR

            if [[ "$RESTART_ONLY" != "true" ]]; then
              mkdir -p "$RELEASE_DIR"
              install -m 755 "$BINARY_STAGING" "$RELEASE_DIR/edgelord"
              rm -f "$BINARY_STAGING"
              ln -sfn "$RELEASE_DIR" "$CURRENT_LINK"
            fi

            if [[ ! -x "$CURRENT_LINK/edgelord" ]]; then
              echo "Missing binary at $CURRENT_LINK/edgelord"
              exit 1
            fi

            if [[ ! -f "$CONFIG_PATH" ]]; then
              echo "Missing config at $CONFIG_PATH"
              exit 1
            fi

            "$CURRENT_LINK/edgelord" check config --config "$CONFIG_PATH"
            if [[ "$RUN_LIVE_CHECK" == "true" ]]; then
              "$CURRENT_LINK/edgelord" check live --config "$CONFIG_PATH"
            fi

            sudo "$CURRENT_LINK/edgelord" service install --config "$CONFIG_PATH" --user "$DEPLOY_USER" --working-dir "$DEPLOY_PATH"
            sudo systemctl restart edgelord
            sleep 2
            sudo systemctl is-active edgelord

            trap - ERR
            echo "Deployment completed"
          REMOTE
