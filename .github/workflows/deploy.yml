name: Deploy

on:
  # Uncomment to enable automatic deployment on push to main
  # push:
  #   branches: [main]
  #   paths-ignore:
  #     - 'docs/**'
  #     - '*.md'
  #     - 'LICENSE'
  workflow_dispatch:
    inputs:
      skip_deploy:
        description: 'Skip deployment (build and test only)'
        required: false
        default: 'false'
        type: boolean

env:
  CARGO_TERM_COLOR: always

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-action@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Build release
        run: cargo build --release

      - name: Run tests
        run: cargo test --release

      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: edgelord-linux
          path: target/release/edgelord
          retention-days: 7

  deploy:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event.inputs.skip_deploy != 'true'
    environment: production

    steps:
      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: edgelord-linux

      - name: Make binary executable
        run: chmod +x edgelord

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to VPS
        run: |
          # Copy binary to VPS
          scp edgelord ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:/tmp/edgelord-new

          # SSH and deploy
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
            set -e

            # Stop service
            sudo systemctl stop edgelord || true

            # Backup old binary
            if [ -f /opt/edgelord/edgelord ]; then
              sudo cp /opt/edgelord/edgelord /opt/edgelord/edgelord.bak
            fi

            # Install new binary
            sudo mv /tmp/edgelord-new /opt/edgelord/edgelord
            sudo chown edgelord:edgelord /opt/edgelord/edgelord
            sudo chmod +x /opt/edgelord/edgelord

            # Start service
            sudo systemctl start edgelord

            # Verify it's running
            sleep 2
            sudo systemctl is-active edgelord
          EOF

      - name: Notify success
        if: success()
        run: |
          echo "Deployment successful!"
          # TODO: Add Telegram notification

      - name: Rollback on failure
        if: failure()
        run: |
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
            if [ -f /opt/edgelord/edgelord.bak ]; then
              sudo mv /opt/edgelord/edgelord.bak /opt/edgelord/edgelord
              sudo systemctl start edgelord || true
            fi
          EOF
